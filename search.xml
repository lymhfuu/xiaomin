<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Unityåç¨‹çš„åŸç†</title>
    <url>/xiaomin.github.io/2025/11/21/hello-world/</url>
    <content><![CDATA[ä¸€ã€åç¨‹çš„æ¦‚å¿µ

åç¨‹ä¸æ˜¯çº¿ç¨‹  â—‹ å®ƒä¸ä¼šå¹¶è¡Œæ‰§è¡Œï¼Œä¹Ÿä¸ä¼šå ç”¨ç³»ç»Ÿçº¿ç¨‹  â—‹ å…¨éƒ¨åœ¨ Unity ä¸»çº¿ç¨‹æ‰§è¡Œ
åç¨‹æ˜¯å¯æš‚åœçš„é€»è¾‘ç‰‡æ®µ  â—‹ ä½¿ç”¨ IEnumeratorï¼Œé€šè¿‡ yield return æš‚åœ  â—‹ æ¯æ¬¡æš‚åœæ—¶ä¿å­˜å½“å‰çŠ¶æ€ï¼Œä¸‹æ¬¡æ¢å¤ç»§ç»­æ‰§è¡Œ
åç¨‹çš„ä½œç”¨  â—‹ åˆ†å¸§æ‰§è¡Œé€»è¾‘ï¼ˆä¾‹å¦‚æŠ€èƒ½å‰æ‘‡ã€Buff æŒç»­ï¼‰  â—‹ å»¶è¿Ÿé€»è¾‘ï¼ˆç­‰å¾…ä¸€æ®µæ—¶é—´æˆ–ç­‰å¾…ç‰©ç†å®Œæˆï¼‰äºŒã€C# å±‚é¢çš„å®ç°æœºåˆ¶

Unity çš„åç¨‹æœ¬è´¨ä¾èµ– C# ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºï¼šIEnumerator MyCoroutine(){    print(â€œå¼€å§‹â€);    yield return null;    print(â€œä¸‹ä¸€å¸§ç»§ç»­â€);}1ï¸ ç¼–è¯‘å™¨è½¬æ¢ç¼–è¯‘å™¨ä¼šæŠŠè¿™ä¸ªæ–¹æ³•è½¬æ¢æˆä¸€ä¸ª çŠ¶æ€æœºç±»ï¼š
class MyCoroutineStateMachine : IEnumerator&#123;    int state = 0;    public bool MoveNext()    &#123;        switch (state)        &#123;            case 0:                print(&quot;å¼€å§‹&quot;);                state = 1;                return true; // yield return null            case 1:                print(&quot;ä¸‹ä¸€å¸§ç»§ç»­&quot;);                state = -1;                return false; // åç¨‹ç»“æŸ        &#125;        return false;    &#125;&#125;
â— æ¯æ¬¡è°ƒç”¨ MoveNext() å°±æ¨è¿›åç¨‹ä¸€æ¬¡â— yield return æœ¬è´¨æ˜¯ï¼š

æš‚åœå‡½æ•°
ä¿å­˜ state
è¿”å›ä¸€ä¸ªå€¼ç»™è°ƒåº¦å™¨ï¼ˆæ¯”å¦‚ null, WaitForSeconds, WaitForFixedUpdateï¼‰2ï¸ åç¨‹çš„å…³é”®å­—æ®µâ— stateï¼šè®°å½•åç¨‹æ‰§è¡Œåˆ°å“ªä¸€æ­¥â— Currentï¼šå­˜å‚¨ yield return çš„å¯¹è±¡ï¼Œç”¨äºè°ƒåº¦å™¨åˆ¤æ–­ä½•æ—¶æ¢å¤â— MoveNext()ï¼šæ¯å¸§ç”± Unity è°ƒåº¦è°ƒç”¨ä¸‰ã€Unity å±‚é¢çš„è°ƒåº¦æœºåˆ¶Unity åœ¨å†…éƒ¨æœ‰ä¸€ä¸ª Coroutine Managerï¼š1ï¸ è°ƒåº¦é˜Ÿåˆ—Unity ä¼šç»´æŠ¤ä¸€ä¸ª åˆ—è¡¨&#x2F;é˜Ÿåˆ—ï¼Œå­˜å‚¨æ‰€æœ‰æŒ‚èµ·çš„åç¨‹ï¼šList waitingCoroutinesâ— æ¯ä¸ªåç¨‹å¯¹åº”ä¸€ä¸ª IEnumerator çŠ¶æ€æœºâ— æ¯å¸§æ›´æ–°æ—¶ï¼ŒUnity éå†åˆ—è¡¨ï¼šâ— åˆ¤æ–­ Current è¿”å›çš„å¯¹è±¡ç±»å‹  â—‹ null â†’ ä¸‹ä¸€å¸§æ¢å¤  â—‹ WaitForSeconds â†’ ç­‰å¾…æ—¶é—´åˆ°å†æ¢å¤  â—‹ WaitForFixedUpdate â†’ ç­‰ FixedUpdate åæ¢å¤  â—‹ WaitForEndOfFrame â†’ æ¸²æŸ“åæ¢å¤2ï¸ æ¢å¤æ—¶æœºyield return ç±»å‹	æ¢å¤æ—¶æœºnull	ä¸‹ä¸€å¸§ Update å®Œå &#x2F; LateUpdate å‰WaitForFixedUpdate	ä¸‹ä¸€æ¬¡ FixedUpdate ç»“æŸåWaitForEndOfFrame	æœ¬å¸§æ¸²æŸ“å®ŒæˆåWaitForSeconds(x)	ç­‰ x ç§’åæ¢å¤3ï¸ æ‰§è¡Œæµç¨‹ä»¥ yield return null ä¸ºä¾‹ï¼šå¸§ nï¼š


StartCoroutine(MyCoroutine) è°ƒç”¨
IEnumerator ç”ŸæˆçŠ¶æ€æœºï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—
MyCoroutine ç¬¬ä¸€æ¬¡ MoveNext æ‰§è¡Œåˆ° yield return null â†’ æš‚åœï¼Œstate ä¿å­˜å¸§ n+1ï¼š
Unity éå†ç­‰å¾…é˜Ÿåˆ—
MoveNext() å†æ¬¡è°ƒç”¨ â†’ åç¨‹ç»§ç»­æ‰§è¡Œ
æ³¨æ„ï¼šçŠ¶æ€æœºä¿å­˜äº†å±€éƒ¨å˜é‡å’Œæ‰§è¡Œä½ç½®ï¼Œè¿™å°±æ˜¯â€œè·¨å¸§ä¿æŒä¸Šä¸‹æ–‡â€çš„ç§˜å¯†ã€‚å››ã€åç¨‹å®ç°çš„æ ¸å¿ƒåŸç†æ€»ç»“




C# å±‚é¢  â—‹ IEnumerator + ç¼–è¯‘å™¨çŠ¶æ€æœº  â—‹ yield return â†’ ä¿å­˜çŠ¶æ€ + æš‚åœæ‰§è¡Œ
Unity å±‚é¢  â—‹ Coroutine Manager ç»´æŠ¤æŒ‚èµ·é˜Ÿåˆ—  â—‹ æ¯å¸§éå†åˆ¤æ–­æ˜¯å¦æ¢å¤  â—‹ æ¢å¤æ—¶æœºä¾èµ–è¿”å›å¯¹è±¡ç±»å‹
ç‰¹æ€§  â—‹ éå¹¶è¡Œï¼šåç¨‹åªæ˜¯åœ¨ä¸»çº¿ç¨‹åˆ†å¸§æ‰§è¡Œ  â—‹ å¯è·¨å¸§ä¿æŒå±€éƒ¨å˜é‡çŠ¶æ€  â—‹ å¯å»¶è¿Ÿé€»è¾‘&#x2F;æ§åˆ¶æ‰§è¡Œé¡ºåºäº”ã€ä¸¾ä¾‹ï¼šæŠ€èƒ½å‰æ‘‡ç³»ç»Ÿå‡è®¾åšæˆ˜æ–—ç³»ç»Ÿï¼š

IEnumerator SkillCast(){    isCasting &#x3D; true;    &#x2F;&#x2F; å‰æ‘‡ 0.5 ç§’    yield return new WaitForSeconds(0.5f);
DealDamage(); // æ”»å‡»å‘½ä¸­
isCasting = false;

}æ‰§è¡ŒåŸç†ï¼š

StartCoroutine â†’ çŠ¶æ€æœºç”Ÿæˆ â†’ å…¥é˜Ÿ
MoveNext æ‰§è¡Œ â†’ æš‚åœåœ¨ WaitForSeconds
æ¯å¸§æ£€æŸ¥æ—¶é—´æ˜¯å¦åˆ° â†’ æ¡ä»¶æ»¡è¶³ â†’ MoveNext ç»§ç»­ â†’ DealDamage æ‰§è¡Œ
çŠ¶æ€æœºç»“æŸ â†’ ä»é˜Ÿåˆ—ç§»é™¤


ğŸ’¡ è¿™æ ·å°±èƒ½å®ç° åˆ†å¸§æ‰§è¡Œã€å»¶è¿Ÿæ•ˆæœã€çŠ¶æ€ä¿æŒï¼Œè€Œä¸é˜»å¡ä¸»çº¿ç¨‹

å…­ã€state çš„æœ¬è´¨åœ¨ Unity &#x2F; C# åç¨‹ä¸­ï¼šstate ä¿å­˜çš„æ˜¯ åç¨‹æ‰§è¡Œåˆ°äº†å“ªä¸€æ­¥ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºâ€œæŒ‡é’ˆâ€ï¼Œå‘Šè¯‰åç¨‹â€œä¸‹ä¸€æ¬¡ä»å“ªè¡Œä»£ç ç»§ç»­æ‰§è¡Œâ€ã€‚IEnumerator MyCoroutine(){    int x &#x3D; 0;    print(â€œå¼€å§‹â€);    yield return null;     &#x2F;&#x2F; æš‚åœç‚¹ 1    x +&#x3D; 1;    print(â€œä¸‹ä¸€å¸§ç»§ç»­â€);    yield return null;     &#x2F;&#x2F; æš‚åœç‚¹ 2    print(â€œç»“æŸâ€);} C# ç¼–è¯‘å™¨ä¼šç”Ÿæˆå¤§è‡´è¿™æ ·ä¸€ä¸ªçŠ¶æ€æœºç±»ï¼š  
class MyCoroutineStateMachine : IEnumerator&#123;    int state = 0;      // &lt;--- ä¿å­˜å½“å‰ä½ç½®    int x;              // &lt;--- ä¿å­˜å±€éƒ¨å˜é‡    public object Current &#123; get; private set; &#125;    public bool MoveNext()    &#123;        switch (state)        &#123;            case 0:                x = 0;                 print(&quot;å¼€å§‹&quot;);                Current = null;                state = 1;  // ä¸‹ä¸€æ¬¡ MoveNext ä» case 1 å¼€å§‹                return true;            case 1:                x += 1;                print(&quot;ä¸‹ä¸€å¸§ç»§ç»­&quot;);                Current = null;                state = 2;  // ä¸‹ä¸€æ¬¡ MoveNext ä» case 2 å¼€å§‹                return true;            case 2:                print(&quot;ç»“æŸ&quot;);                state = -1; // åç¨‹ç»“æŸ                return false;        &#125;        return false;    &#125;&#125;

æ€»ç»“ state ä¿å­˜çš„å†…å®¹

åç¨‹æ‰§è¡Œä½ç½®  â—‹ å“ªä¸ª yield return æš‚åœäº†  â—‹ ä¸‹ä¸€æ¬¡ MoveNext() åº”è¯¥ä»å“ªä¸ªä½ç½®ç»§ç»­
å±€éƒ¨å˜é‡å’Œå‚æ•°çš„å¿«ç…§  â—‹ ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨ state é‡Œï¼Œä½†ç¼–è¯‘å™¨ä¼šæŠŠå®ƒä»¬å˜æˆçŠ¶æ€æœºçš„æˆå‘˜å˜é‡  â—‹ ä¿è¯è·¨å¸§ä¿æŒå€¼
ç‰¹æ®Šå€¼ -1  â—‹ è¡¨ç¤ºåç¨‹å·²ç»ç»“æŸä¸ºä»€ä¹ˆéœ€è¦ stateï¼Ÿå¦‚æœæ²¡æœ‰ stateï¼Œåç¨‹å°±æ²¡åŠæ³•è·¨å¸§ä¿å­˜ä¸Šä¸‹æ–‡ï¼šâ— ä½ çš„å‰æ‘‡æŠ€èƒ½æŒ‚èµ· 0.5 ç§’â— ä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡Œ DealDamageâ— å¦‚æœæ²¡æœ‰ stateï¼Œå°±ä¸çŸ¥é“è¯¥ä»å“ªä¸€è¡Œç»§ç»­ï¼Œä¹Ÿæ— æ³•ä¿ç•™å±€éƒ¨å˜é‡ xä¸ƒã€ ä½“æ˜¯å¦‚ä½•åˆ¤æ–­ç»§ç»­æ‰§è¡Œçš„æ¡ä»¶ä¸€ã€åç¨‹æ¢å¤çš„æ ¸å¿ƒé€»è¾‘
åç¨‹æœ¬èº«æ˜¯ä¸€ä¸ª IEnumerator çŠ¶æ€æœº  â—‹ state ä¿å­˜ä½ç½®  â—‹ Current ä¿å­˜ yield return çš„å€¼
Unity æ¯å¸§ä¼šéå†æŒ‚èµ·çš„åç¨‹é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹ æ¯ä¸ªåç¨‹çš„ Current è¿”å›å€¼ï¼Œå†³å®šæ˜¯å¦å¯ä»¥è°ƒç”¨ MoveNext() ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥åˆ¤æ–­â€œæ˜¯å¦ç»§ç»­æ‰§è¡Œâ€ï¼Œå®Œå…¨ä¾èµ– yield è¿”å›çš„å¯¹è±¡ç±»å‹ã€‚äºŒã€ä¸åŒ yield å¯¹åº”çš„æ¡ä»¶




yield return ç±»å‹
Unity åˆ¤æ–­æ¡ä»¶ï¼ˆä½•æ—¶è°ƒç”¨ MoveNextï¼‰
è¯´æ˜



null
ä¸‹ä¸€å¸§ Update ç»“æŸ
è·¨ä¸€å¸§ï¼Œç«‹å³æ¢å¤


WaitForSeconds(seconds)
ç­‰å¾…ç´¯è®¡æ—¶é—´ &gt;&#x3D; seconds
Unity å†…éƒ¨è®¡æ—¶å™¨ï¼Œæ¯å¸§ç´¯åŠ  deltaTimeï¼Œæ—¶é—´åˆ°æ¢å¤


WaitForFixedUpdate
FixedUpdate å®Œæˆ
ä¸‹ä¸€æ¬¡ç‰©ç†å¸§ç»“æŸåæ¢å¤


WaitForEndOfFrame
æœ¬å¸§æ¸²æŸ“å®Œæˆ
åœ¨æ¸²æŸ“ç®¡çº¿æœ«å°¾æ¢å¤ï¼ˆLateUpdate åï¼‰


è‡ªå®šä¹‰ yield å¯¹è±¡ï¼ˆICustomYieldInstructionï¼‰
keepWaiting &#x3D;&#x3D; false
è‡ªå®šä¹‰æ¡ä»¶åˆ¤æ–­ï¼Œè¿”å› false æ—¶æ¢å¤


ä¸‰ã€å†…éƒ¨åŸç†å‡è®¾åç¨‹é˜Ÿåˆ—æ˜¯è¿™æ ·ï¼šList waitingCoroutines; æ¯å¸§å¤§è‡´ä¼ªä»£ç ï¼š  
for each coroutine in waitingCoroutines:    object yieldObj = coroutine.Current;        if (CanResume(yieldObj)):        bool hasNext = coroutine.MoveNext();        if (!hasNext) remove from waitingCoroutines

CanResume(yieldObj) çš„é€»è¾‘ï¼š  
bool CanResume(object yieldObj)&#123;    if (yieldObj == null) return true; // ä¸‹ä¸€å¸§ç«‹å³æ¢å¤    if (yieldObj is WaitForSeconds wfs) return wfs.timeElapsed &gt;= wfs.duration;    if (yieldObj is WaitForFixedUpdate) return FixedUpdateDoneThisFrame;    if (yieldObj is WaitForEndOfFrame) return EndOfFrameReached;    if (yieldObj is ICustomYieldInstruction c) return !c.keepWaiting;    return false;&#125;]]></content>
      <categories>
        <category>Unityå¼€å‘</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
</search>
